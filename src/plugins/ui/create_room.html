<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<body>
    <div>
        <span>Nickname : </span><input type="text" name="nickname" id="nicknameInput">
        <button id="tryAnotherNicknameBtn">Try Another Nickname!</button>
    </div>
    <div class="settings">
        <br>
        <h2>Game Settings</h2>
        <span>Number of Rounds : </span><input type="text" name="numRounds" id="numRoundsInput" value="3">
        <span>Round Time : </span><input type="text" name="roundTime" id="roundTimeInput" value="100">     
    </div>
    <div>
        <br>
        <button id="createRoomBtn">Create Room!</button>
    </div>
    <p>Room link : <a id="roomLink" href="#"></a></p>
    <script>
        const createRoomBtn = document.getElementById('createRoomBtn');
        const tryAnotherNicknameBtn = document.getElementById('tryAnotherNicknameBtn');
        const roomLink = document.getElementById('roomLink');
        const nicknameInput = document.getElementById('nicknameInput');

        function readNickname() {
            function enableInputChange() {
                nicknameInput.disabled = false;
                nicknameInput.addEventListener('input',
                    changeNicknameHandler)
            }
            nicknameInput.disabled = true;
            const nickname = localStorage.getItem('nickname');
            if (nickname) {
                nicknameInput.value = nickname;
                enableInputChange();
            } else {
                fetch('/nickname')
                    .then((response) => {
                        return response.json();
                    })
                    .then(data => {
                        console.log(data)
                        nicknameInput.value = data.nickname;
                        changeNicknameHandler.apply(nicknameInput)
                        enableInputChange();
                    })
                    .catch((data) => {
                        enableInputChange();
                    })
            }
        };

        readNickname();

        createRoomBtn.addEventListener('click', createRoomBtnHandler);
        tryAnotherNicknameBtn.addEventListener('click', tryAnotherNicknameHandler);

        function createRoomBtnHandler() {
            createRoomBtn.removeEventListener('click', () => {});
            console.log('request sent!')
            const body = { numRounds: document.getElementById('numRoundsInput').value,
                    roundTime: document.getElementById('roundTimeInput').value
                };
            fetch('/rooms', {
                    method: 'post',
                    body:    JSON.stringify(body),
                    headers: { 'Content-Type': 'application/json' }
                })
                .then((response) => {
                    return response.json();
                })
                .then((data) => {
                    roomLink.innerText = data.link;
                    roomLink.href = data.link;
                    createRoomBtn.addEventListener('click', createRoomBtnHandler);
                })
                .catch((data) => {
                    createRoomBtn.addEventListener('click', createRoomBtnHandler);
                });
        }

        function changeNicknameHandler() {
            const nickname = this.value;
            localStorage.setItem('nickname', nickname);
        }

        function tryAnotherNicknameHandler() {
            localStorage.removeItem('nickname');
            readNickname();
        }

        function changeNicknameHandler() {
            const nickname = this.value;
            localStorage.setItem('nickname', nickname);
        }
    </script>
</body>

</html>